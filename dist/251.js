"use strict";(self.webpackChunkweoreum_ts=self.webpackChunkweoreum_ts||[]).push([[251],{54251:function(e,t,n){n.r(t),n.d(t,{default:function(){return S}});var r=n(67294),o=n(35366),l=(0,o.Z)("div",{target:"ehesl3h1"})({name:"90qzpz",styles:"display:flex;flex-wrap:wrap;height:calc(100vh - 70px);flex-flow:column;position:relative"}),a=(0,o.Z)("header",{target:"ehesl3h0"})({name:"2cg0dz",styles:"height:64px;display:flex;width:100%;--saf-0:rgba(var(--sk_foreground_low, 29, 28, 29), 0.13);border-top:solid 1px rgba(1, 1, 1, 0.2);box-shadow:0 1px 0 var(--saf-0);padding:20px 16px 20px 20px;font-weight:bold;align-items:center;& img{margin-right:5px;}"}),c=n(66182),i=n.n(c),u=n(8100),s=n(83564),f=n(5977),d=n(80509),m=n(17354),h=n(38678),p=n(9669),v=n.n(p),g=n(18667),b=n(44593),y=n(32951),w=n(72132);function x(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,l=[],a=!0,c=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(l.push(r.value),!t||l.length!==t);a=!0);}catch(e){c=!0,o=e}finally{try{a||null==n.return||n.return()}finally{if(c)throw o}}return l}}(e,t)||function(e,t){if(e){if("string"==typeof e)return k(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?k(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function k(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var S=function(){var e,t,n=(0,r.useRef)(null),o=(0,f.UO)(),c=o.workspace,p=o.id,k=(0,u.ZP)("/api/users",s.Z),S=k.data,Z=(k.error,k.mutate,(0,u.ZP)("/api/workspaces/".concat(c,"/users/").concat(p),s.Z).data),E=(0,b.ZP)((function(e){return"/api/workspaces/".concat(c,"/dms/").concat(p,"/chats?perPage=20&page=").concat(e+1)}),s.Z),C=E.data,A=E.mutate,T=E.setSize,I=x((0,y.Z)(c),1)[0],z=0===(null==C||null===(e=C[0])||void 0===e?void 0:e.length),B=z||C&&(null===(t=C[C.length-1])||void 0===t?void 0:t.length)<20||!1,R=x((0,h.Z)(""),3),O=R[0],P=R[1],_=R[2],j=(0,r.useCallback)((function(e){if(e.preventDefault(),null!=O&&O.trim()&&C){var t=O;A((function(e){var n;return null==e||e[0].unshift({id:((null===(n=C[0][0])||void 0===n?void 0:n.id)||0)+1,content:t,SenderId:S.id,Sender:S,ReceiverId:Z.id,Receiver:Z,createdAt:new Date}),e}),!1).then((function(){var e;_(""),null===(e=n.current)||void 0===e||e.scrollToBottom()})),v().post("/api/workspaces/".concat(c,"/dms/").concat(p,"/chats"),{content:O}).then((function(){A()})).catch(console.error)}}),[O,C,S,Z,c,p]),D=(0,r.useCallback)((function(e){e.SenderId===Number(p)&&S.id!==Number(p)&&A((function(t){return null==t||t[0].unshift(e),t}),!1).then((function(){var e;n.current&&(n.current.getScrollHeight()<n.current.getClientHeight()+n.current.getScrollTop()+150?(console.log("scrollToBottom!",null===(e=n.current)||void 0===e?void 0:e.getValues()),setTimeout((function(){var e;null===(e=n.current)||void 0===e||e.scrollToBottom()}),100)):w.Am.success("새 메시지가 도착했습니다.",{onClick:function(){var e;null===(e=n.current)||void 0===e||e.scrollToBottom()},closeOnClick:!0}))}))}),[p,S,A]);if((0,r.useEffect)((function(){return null==I||I.on("dm",D),function(){null==I||I.off("dm",D)}}),[I,D]),(0,r.useEffect)((function(){var e;1===(null==C?void 0:C.length)&&(null===(e=n.current)||void 0===e||e.scrollToBottom())}),[C]),!S||!Z)return null;var H=(0,g.Z)(C?C.flat().reverse():[]);return r.createElement(l,null,r.createElement(a,null,r.createElement("img",{src:i().url(Z.email,{s:"24px",d:"retro"}),alt:Z.nickname}),r.createElement("span",null,Z.nickname)),r.createElement(m.Z,{chatSections:H,scrollbarRef:n,setSize:T,isEmpty:z,isReachingEnd:B}),r.createElement(d.Z,{chat:O,onChangeChat:P,onSubmitForm:j,placeholder:"채팅입력"}))}}}]);